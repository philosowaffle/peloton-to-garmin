@page "/sync"
@inject HttpClient Http

<h1>Sync Workouts</h1>

<p>Sync your latest workouts from Peloton to Garmin.</p>

<EditForm Model="@postRequest" OnValidSubmit="@OnClickSyncAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <p>
        <label>
            Number of Workouts to Sync:
            <InputNumber @bind-Value="postRequest.NumWorkouts" />
        </label>
    </p>

    <button type="submit">Submit</button>
</EditForm>


@if (syncing is null)
{

}
else if (syncing.GetValueOrDefault())
{
    <p><em>Syncing, Please Wait...</em></p>
}
else
{
    <p>Sync Success: @syncSuccess.SyncSuccess</p>
    <ol>
        <li>Peloton Download Success: @syncSuccess.PelotonDownloadSuccess</li>
        <li>Convert to FIT Success: @syncSuccess.ConverToFitSuccess</li>
        <li>Upload to Garmin Success: @syncSuccess.UploadToGarminSuccess</li>
    </ol>

    if (syncSuccess.Errors.Any())
    {
        foreach (var error in syncSuccess.Errors)
        {
        <ul>
            <li><em>@error.Message</em></li>
        </ul>
        }
    }
}


@code {
    private SyncPostRequest postRequest = new SyncPostRequest();
    private SyncPostResponse syncSuccess = null;
    private bool? syncing = null;

    protected async Task OnClickSyncAsync()
    {
        Log.Information("Calling SyncController.");
        syncing = true;
        var response = await Http.PostAsJsonAsync("/sync", postRequest);
        syncing = false;

        syncSuccess = await response.Content.ReadFromJsonAsync<SyncPostResponse>();
    }
}
